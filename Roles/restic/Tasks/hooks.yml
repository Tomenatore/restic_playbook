---
# roles/restic/tasks/hooks.yml
# Deploy pre/post backup hooks (uses Restic's native hook system)
#
# Hooks use Restic's native hook system (RESTIC_PRE_SCRIPT, RESTIC_POST_SCRIPT)
#
# Option 1: Global hooks directory (restic_custom_hooks_dir)
#   - Copies hooks from control node: pre-backup-<source>.sh, post-backup-<source>.sh
#
# Option 2: Per-source hook scripts (item.hook_pre_script, item.hook_post_script)
#   - Copies specific hook script per source
#
# Option 3: Manual hook management
#   - User manually creates hooks on target hosts in restic_hooks_dir
#
# Note: Hooks are optional. If not present, backup runs without hooks.

- name: Copy pre-backup hooks from custom directory
  ansible.builtin.copy:
    src: "{{ restic_custom_hooks_dir }}/pre-backup-{{ item.name }}.sh"
    dest: "{{ item.hook_script_dir | default(restic_hooks_dir) }}/pre-backup-{{ item.name }}.sh"
    mode: '0755'
    owner: root
    group: root
  loop: "{{ restic_backup_sources | selectattr('enabled') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - restic_custom_hooks_dir | length > 0
    - item.hook_pre_script is not defined
  ignore_errors: yes  # Hook might not exist for this source

- name: Copy post-backup hooks from custom directory
  ansible.builtin.copy:
    src: "{{ restic_custom_hooks_dir }}/post-backup-{{ item.name }}.sh"
    dest: "{{ item.hook_script_dir | default(restic_hooks_dir) }}/post-backup-{{ item.name }}.sh"
    mode: '0755'
    owner: root
    group: root
  loop: "{{ restic_backup_sources | selectattr('enabled') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - restic_custom_hooks_dir | length > 0
    - item.hook_post_script is not defined
  ignore_errors: yes  # Hook might not exist for this source

- name: Copy per-source pre-backup hook script
  ansible.builtin.copy:
    src: "{{ item.hook_pre_script }}"
    dest: "{{ item.hook_script_dir | default(restic_hooks_dir) }}/pre-backup-{{ item.name }}.sh"
    mode: '0755'
    owner: root
    group: root
  loop: "{{ restic_backup_sources | selectattr('enabled') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - item.hook_pre_script is defined
    - item.hook_pre_script | length > 0

- name: Copy per-source post-backup hook script
  ansible.builtin.copy:
    src: "{{ item.hook_post_script }}"
    dest: "{{ item.hook_script_dir | default(restic_hooks_dir) }}/post-backup-{{ item.name }}.sh"
    mode: '0755'
    owner: root
    group: root
  loop: "{{ restic_backup_sources | selectattr('enabled') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - item.hook_post_script is defined
    - item.hook_post_script | length > 0
