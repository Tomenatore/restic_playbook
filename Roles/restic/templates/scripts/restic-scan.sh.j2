#!/bin/bash
# Restic Snapshot Scan Script for {{ item.name }}
# Generated by Ansible - DO NOT EDIT MANUALLY

set -e
set -o pipefail

# Source configuration
SOURCE_NAME="{{ item.name }}"
LOG_TAG="restic-scan-${SOURCE_NAME}"
STATS_FILE="{{ restic_config_dir }}/stats-${SOURCE_NAME}.json"

# Log start
logger -t "${LOG_TAG}" -p user.info "Starting snapshot scan for ${SOURCE_NAME}"

# Get snapshots
if ! SNAPSHOTS=$(restic snapshots --tag "${SOURCE_NAME}" --json 2>&1); then
    logger -t "${LOG_TAG}" -p user.error "Failed to retrieve snapshots"
    exit 1
fi

# Get repository stats
if ! STATS=$(restic stats --mode restore-size --json 2>&1); then
    logger -t "${LOG_TAG}" -p user.error "Failed to retrieve repository stats"
    exit 1
fi

# Save stats to file
echo "${STATS}" > "${STATS_FILE}"

# Parse and log key metrics
TOTAL_SIZE=$(echo "${STATS}" | jq -r '.total_size // 0')
TOTAL_FILE_COUNT=$(echo "${STATS}" | jq -r '.total_file_count // 0')
SNAPSHOT_COUNT=$(echo "${SNAPSHOTS}" | jq '. | length')

TOTAL_SIZE_GB=$(echo "scale=2; ${TOTAL_SIZE} / 1073741824" | bc)

logger -t "${LOG_TAG}" -p user.info "Scan complete: ${SNAPSHOT_COUNT} snapshots, ${TOTAL_FILE_COUNT} files, ${TOTAL_SIZE_GB} GB"

echo "Snapshots: ${SNAPSHOT_COUNT}"
echo "Total files: ${TOTAL_FILE_COUNT}"
echo "Total size: ${TOTAL_SIZE_GB} GB"

exit 0
